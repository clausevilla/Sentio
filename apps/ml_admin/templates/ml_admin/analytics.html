{% extends 'ml_admin/base_admin.html' %}
{% load static %}
{% block title %}Analytics{% endblock %}
{% block page_title %}User Analytics{% endblock %}
{% block page_css %}<link rel="stylesheet" href="{% static 'ml_admin/css/analytics.css' %}">{% endblock %}

{% block content %}
<!-- Prediction Stats -->
<div class="section-header">
    <h2><i class="fas fa-brain"></i> Predictions</h2>
</div>

{% if prediction_stats.available %}
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon coral"><i class="fas fa-chart-line"></i></div>
        <div class="stat-value">{{ prediction_stats.total }}</div>
        <div class="stat-label">Total Predictions</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-value">{{ prediction_stats.today }}</div>
        <div class="stat-label">Today</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-calendar-week"></i></div>
        <div class="stat-value">{{ prediction_stats.week }}</div>
        <div class="stat-label">This Week</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-calendar"></i></div>
        <div class="stat-value">{{ prediction_stats.month }}</div>
        <div class="stat-label">This Month</div>
    </div>
    {% if prediction_stats.avg_confidence %}
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-percentage"></i></div>
        <div class="stat-value">{{ prediction_stats.avg_confidence }}%</div>
        <div class="stat-label">Avg Confidence</div>
    </div>
    {% endif %}
</div>

<div class="grid-2">
    <!-- Mental State Distribution -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-chart-pie"></i> Mental State Distribution</h3>
        </div>
        <div class="card-body">
            {% if prediction_stats.distribution %}
            <div class="chart-wrap"><canvas id="mentalStateChart"></canvas></div>
            {% else %}
            <div class="empty-state small"><p>No prediction data</p></div>
            {% endif %}
        </div>
    </div>
    
    <!-- Daily Predictions Trend -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-chart-area"></i> Daily Predictions (14 days)</h3>
        </div>
        <div class="card-body">
            {% if prediction_stats.daily_counts %}
            <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
            {% else %}
            <div class="empty-state small"><p>No prediction data</p></div>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
<div class="alert warning">
    <i class="fas fa-exclamation-triangle"></i>
    <span>Prediction tracking not available. Make sure the predictions app is installed and migrations are applied.</span>
</div>
{% endif %}

<!-- Submissions Stats -->
<div class="section-header">
    <h2><i class="fas fa-file-alt"></i> User Submissions</h2>
</div>

{% if submission_stats.available %}
<div class="stats-row small">
    <div class="stat-card">
        <div class="stat-value">{{ submission_stats.total }}</div>
        <div class="stat-label">Total Submissions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ submission_stats.today }}</div>
        <div class="stat-label">Today</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ submission_stats.week }}</div>
        <div class="stat-label">This Week</div>
    </div>
</div>
{% else %}
<div class="alert info">
    <i class="fas fa-info-circle"></i>
    <span>Submission tracking not available.</span>
</div>
{% endif %}

<!-- User Stats -->
<div class="section-header">
    <h2><i class="fas fa-users"></i> Users</h2>
</div>

<div class="stats-row small">
    <div class="stat-card">
        <div class="stat-value">{{ user_stats.total }}</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ user_stats.active }}</div>
        <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ user_stats.new_week }}</div>
        <div class="stat-label">New This Week</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ user_stats.new_month }}</div>
        <div class="stat-label">New This Month</div>
    </div>
</div>

<!-- User Activity Chart -->
{% if user_signups %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3><i class="fas fa-user-plus"></i> New User Signups (30 days)</h3>
    </div>
    <div class="card-body">
        <div class="chart-wrap"><canvas id="signupsChart"></canvas></div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Chart data
    const mentalStateData = {{ prediction_distribution_json|safe }};
    const dailyData = {{ prediction_daily_json|safe }};
    const signupsData = {{ user_signups_json|safe }};
</script>
<script src="{% static 'ml_admin/js/analytics.js' %}"></script>
{% endblock %}
