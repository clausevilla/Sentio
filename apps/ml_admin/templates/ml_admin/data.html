{% extends 'ml_admin/base_admin.html' %}
{% load static %}
{% block title %}Data{% endblock %}
{% block page_title %}Training Data{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-row small">
    <div class="stat-card">
        <div class="stat-value">{{ total_uploads }}</div>
        <div class="stat-label">Datasets</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ validated_count }}</div>
        <div class="stat-label">Validated</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_records }}</div>
        <div class="stat-label">Total Records</div>
    </div>
    <button class="btn btn-primary" onclick="openModal('uploadModal')">
        <i class="fas fa-plus"></i> Upload CSV
    </button>
</div>

<!-- Dataset Cards -->
<div class="dataset-grid">
    {% for item in uploads %}
    <div class="card dataset-card">
        <div class="card-header">
            <div class="dataset-title">
                <i class="fas fa-file-csv"></i>
                <span>{{ item.upload.file_name }}</span>
            </div>
            {% if item.upload.is_validated %}
            <span class="badge success">Validated</span>
            {% else %}
            <span class="badge warning">Pending</span>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="dataset-meta">
                <span><i class="fas fa-calendar"></i> {{ item.upload.uploaded_at|date:"M d, Y" }}</span>
                <span><i class="fas fa-user"></i> {{ item.upload.uploaded_by.username|default:"-" }}</span>
                <span><i class="fas fa-table"></i> {{ item.upload.row_count|default:0 }} rows</span>
            </div>

            <!-- Inline Distribution -->
            {% if item.distribution %}
            <div class="distribution-bars">
                {% for d in item.distribution %}
                <div class="dist-item">
                    <span class="dist-label">{{ d.label }}</span>
                    <div class="dist-bar">
                        <div class="dist-fill" style="width: {% widthratio d.count item.upload.row_count 100 %}%"></div>
                    </div>
                    <span class="dist-count">{{ d.count }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="dataset-actions">
                <button class="btn btn-sm btn-secondary" onclick="viewRecords({{ item.upload.id }}, '{{ item.upload.file_name }}')">
                    <i class="fas fa-eye"></i> View Records
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteDataset({{ item.upload.id }}, '{{ item.upload.file_name }}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <i class="fas fa-cloud-upload-alt"></i>
        <h4>No Datasets Yet</h4>
        <p>Upload your first CSV to get started</p>
        <button class="btn btn-primary" onclick="openModal('uploadModal')">
            <i class="fas fa-upload"></i> Upload CSV
        </button>
    </div>
    {% endfor %}
</div>

<!-- Upload Modal -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-upload"></i> Upload CSV</h3>
            <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click or drag CSV file</p>
                <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="fileSelected(this)">
            </div>
            <div class="file-preview" id="filePreview" style="display:none">
                <i class="fas fa-file-csv"></i>
                <span id="fileName"></span>
                <button onclick="clearFile()">&times;</button>
            </div>
            <div class="help-text">
                <strong>Required columns:</strong> <code>text</code> and <code>label</code><br>
                <strong>Labels:</strong> Normal, Depression, Suicidal, Stress
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('uploadModal')">Cancel</button>
            <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()" disabled>
                <i class="fas fa-upload"></i> Upload
            </button>
        </div>
    </div>
</div>

<!-- Records Modal -->
<div class="modal" id="recordsModal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h3><i class="fas fa-table"></i> <span id="recordsTitle">Records</span></h3>
            <button class="modal-close" onclick="closeModal('recordsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="recordsContent">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
            <div class="pagination" id="recordsPagination"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const URLS = {
        uploadCsv: '{% url "ml_admin:upload_csv" %}'
    };
</script>
<script src="{% static 'ml_admin/js/data.js' %}"></script>
{% endblock %}