{% extends 'ml_admin/base_admin.html' %}
{% load static %}
{% block title %}Data{% endblock %}
{% block page_title %}Training Data{% endblock %}
{% block page_css %}<link rel="stylesheet" href="{% static 'ml_admin/css/data.css' %}">{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-database"></i></div>
        <div class="stat-value">{{ total_uploads }}</div>
        <div class="stat-label">Datasets</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-graduation-cap"></i></div>
        <div class="stat-value">{{ type_breakdown.training }}</div>
        <div class="stat-label">Training Records</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-flask"></i></div>
        <div class="stat-value">{{ type_breakdown.test }}</div>
        <div class="stat-label">Test Records</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon coral"><i class="fas fa-question-circle"></i></div>
        <div class="stat-value">{{ type_breakdown.unlabeled }}</div>
        <div class="stat-label">Unlabeled</div>
    </div>
</div>

<!-- Upload Panel (inline, not modal) -->
<div class="card upload-panel" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h3><i class="fas fa-upload"></i> Upload Dataset</h3>
    </div>
    <div class="card-body">
        <div class="upload-row">
            <!-- File Selection -->
            <div class="upload-file-section">
                <div class="upload-zone-inline" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-csv"></i>
                    <span>Choose CSV file...</span>
                    <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="fileSelected(this)">
                </div>
                <div class="file-selected" id="fileSelected" style="display:none">
                    <i class="fas fa-file-csv"></i>
                    <span id="fileName">filename.csv</span>
                    <button class="file-clear" onclick="clearFile()">&times;</button>
                </div>
            </div>

            <!-- Dataset Type -->
            <div class="upload-type-section">
                <label>Dataset Type</label>
                <select id="datasetType" class="form-select">
                    <option value="Training">Training Data</option>
                    <option value="Test">Test Data</option>
                    <option value="Unlabeled">Unlabeled</option>
                </select>
            </div>

            <!-- Upload Button -->
            <button class="btn btn-primary" id="uploadBtn" onclick="uploadFile()" disabled>
                <i class="fas fa-upload"></i> Upload & Process
            </button>
        </div>

        <div class="upload-help">
            <i class="fas fa-info-circle"></i>
            Required columns: <code>text</code> and <code>label</code>
        </div>
    </div>
</div>

<!-- Upload Tasks Queue -->
<div class="upload-tasks" id="uploadTasks" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-tasks"></i> Processing Tasks</h3>
        </div>
        <div class="card-body no-pad">
            <div class="task-list" id="taskList">
                <!-- Tasks will be added here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Overall Label Distribution -->
{% if total_records > 0 %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h3><i class="fas fa-chart-pie"></i> Overall Label Distribution</h3>
    </div>
    <div class="card-body">
        <div class="grid-2">
            <div class="chart-wrap" style="height: 200px;"><canvas id="labelDistChart"></canvas></div>
            <div class="label-stats">
                {% for item in overall_distribution %}
                <div class="label-stat-row">
                    <span class="label-name">{{ item.label }}</span>
                    <div class="label-bar-wrap">
                        <div class="label-bar" style="width: {% widthratio item.count total_records 100 %}%"></div>
                    </div>
                    <span class="label-count">{{ item.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Dataset Cards -->
<div class="dataset-grid">
    {% for item in uploads %}
    <div class="card dataset-card">
        <div class="card-header">
            <div class="dataset-title">
                <i class="fas fa-file-csv"></i>
                <span>{{ item.upload.file_name }}</span>
            </div>
            {% if item.upload.is_validated %}
            <span class="badge success">Validated</span>
            {% else %}
            <span class="badge warning">Pending</span>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="dataset-meta">
                <span><i class="fas fa-calendar"></i> {{ item.upload.uploaded_at|date:"M d, Y" }}</span>
                <span><i class="fas fa-user"></i> {{ item.upload.uploaded_by.username|default:"-" }}</span>
                <span><i class="fas fa-table"></i> {{ item.upload.row_count|default:0 }} rows</span>
            </div>

            <!-- Dataset Type Breakdown -->
            {% if item.type_breakdown %}
            <div class="type-badges">
                {% if item.type_breakdown.Training %}
                <span class="type-badge training"><i class="fas fa-graduation-cap"></i> {{ item.type_breakdown.Training }} train</span>
                {% endif %}
                {% if item.type_breakdown.Test %}
                <span class="type-badge test"><i class="fas fa-flask"></i> {{ item.type_breakdown.Test }} test</span>
                {% endif %}
                {% if item.type_breakdown.Unlabeled %}
                <span class="type-badge unlabeled"><i class="fas fa-question"></i> {{ item.type_breakdown.Unlabeled }} unlabeled</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Inline Distribution -->
            {% if item.distribution %}
            <div class="distribution-bars">
                {% for d in item.distribution %}
                <div class="dist-item">
                    <span class="dist-label">{{ d.label }}</span>
                    <div class="dist-bar">
                        <div class="dist-fill" style="width: {% widthratio d.count item.upload.row_count 100 %}%"></div>
                    </div>
                    <span class="dist-count">{{ d.count }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="dataset-actions">
                <button class="btn btn-sm btn-secondary" onclick="viewRecords({{ item.upload.id }}, '{{ item.upload.file_name }}')">
                    <i class="fas fa-eye"></i> Records
                </button>
                <button class="btn btn-sm btn-secondary" onclick="manageSplit({{ item.upload.id }}, '{{ item.upload.file_name }}')">
                    <i class="fas fa-random"></i> Split
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteDataset({{ item.upload.id }}, '{{ item.upload.file_name }}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state full">
        <i class="fas fa-cloud-upload-alt"></i>
        <h4>No Datasets Yet</h4>
        <p>Upload your first CSV using the panel above</p>
    </div>
    {% endfor %}
</div>

<!-- Records Modal -->
<div class="modal" id="recordsModal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h3><i class="fas fa-table"></i> <span id="recordsTitle">Records</span></h3>
            <button class="modal-close" onclick="closeModal('recordsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="recordsContent">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
            <div class="pagination" id="recordsPagination"></div>
        </div>
    </div>
</div>

<!-- Split Modal -->
<div class="modal" id="splitModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-random"></i> Manage Train/Test Split</h3>
            <button class="modal-close" onclick="closeModal('splitModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="splitContent">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const URLS = {
        uploadCsv: '{% url "ml_admin:upload_csv" %}'
    };
    const labelDistData = {{ overall_distribution_json|safe }};
</script>
<script src="{% static 'ml_admin/js/data.js' %}"></script>
{% endblock %}